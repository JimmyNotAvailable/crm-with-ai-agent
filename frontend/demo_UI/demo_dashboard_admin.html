<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Admin Console - KPI, Security & RAG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. CORE VARIABLES (Light/Dark Theme Support) --- */
        :root {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --text-main: #172b4d;
            --text-sub: #6b778c;
            --border: #dfe1e6;
            --primary: #0065ff;
            --success: #36b37e;
            --warning: #ffab00;
            --danger: #ff5630;
            --chart-line: #0065ff;
            --shadow: 0 1px 3px rgba(0,0,0,0.12);
            --sb-bot-bg: #ffffff;
            --sb-user-bg: #e9f2ff;
        }

        /* DARK MODE OVERRIDES */
        body.dark-mode {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-sidebar: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border: #333333;
            --primary: #4c9aff;
            --chart-line: #4c9aff;
            --shadow: 0 1px 3px rgba(0,0,0,0.5);
            --sb-bot-bg: #2c2c2c;
            --sb-user-bg: #0c2e55;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: background 0.3s, color 0.3s; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- UI UTILS: TOAST --- */
        .toast {
            position: fixed; top: 20px; right: 20px;
            background: #333; color: white; padding: 12px 24px; border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex; align-items: center; gap: 10px; font-size: 14px;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.info { border-left: 4px solid var(--primary); }

        /* --- LAYOUT --- */
        .top-nav { height: 50px; background: #253858; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .main-container { flex: 1; overflow: hidden; display: flex; }
        
        .admin-sidebar { width: 240px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; }
        .menu-item { padding: 12px 20px; cursor: pointer; color: var(--text-sub); display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .menu-item:hover, .menu-item.active { background: rgba(0, 101, 255, 0.1); color: var(--primary); border-right: 3px solid var(--primary); font-weight: 600; }
        
        .admin-content { flex: 1; overflow-y: auto; padding: 25px; }
        .section-view { display: none; animation: fadeIn 0.3s; }
        .section-view.active { display: block; }

        /* --- GENERAL COMPONENTS --- */
        .card { background: var(--bg-card); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .row { display: flex; gap: 20px; }
        .col-8 { flex: 3; } .col-4 { flex: 1; }
        .col-3 { flex: 1; } /* Added for RAG Health Grid */
        
        .btn { padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); cursor: pointer; font-size: 13px; }
        .btn:hover { background: rgba(0,0,0,0.05); }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-outline { background: transparent; border: 1px solid var(--border); }
        
        /* --- SECTION C: INSIGHT DASHBOARD --- */
        .chart-container { height: 250px; position: relative; border-bottom: 1px solid var(--border); display: flex; align-items: flex-end; padding-bottom: 10px; gap: 5px; }
        .bar { background: var(--chart-line); width: 100%; opacity: 0.7; transition: height 0.5s; border-radius: 4px 4px 0 0; position: relative; }
        .bar:hover { opacity: 1; }
        .bar-tooltip { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #333; color: white; font-size: 10px; padding: 2px 5px; border-radius: 3px; display: none; white-space: nowrap; }
        .bar:hover .bar-tooltip { display: block; }

        .alert-feed { max-height: 400px; overflow-y: auto; }
        .alert-item { padding: 12px; border-left: 4px solid var(--border); background: rgba(0,0,0,0.02); margin-bottom: 10px; border-radius: 4px; }
        .alert-item.critical { border-left-color: var(--danger); background: rgba(255, 86, 48, 0.1); }
        .alert-item.warning { border-left-color: var(--warning); background: rgba(255, 171, 0, 0.1); }
        .alert-header { font-weight: bold; font-size: 13px; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .alert-desc { font-size: 12px; color: var(--text-sub); }

        .threshold-config { margin-top: 15px; }
        .slider-group { margin-bottom: 15px; }
        .slider-label { font-size: 12px; display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600; }
        input[type=range] { width: 100%; }

        /* --- SECTION D: SECURITY & AUDIT --- */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border); color: var(--text-sub); background: rgba(0,0,0,0.02); }
        .data-table td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 6px; }
        .filter-input { padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-card); color: var(--text-main); font-size: 12px; }
        .pii-badge { background: rgba(255, 189, 173, 0.3); color: #bf2600; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; border: 1px solid var(--danger); }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }

        /* --- SECTION: RAG & KB STYLES --- */
        .rag-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        
        /* Gauge Chart Styles */
        .gauge-wrapper { width: 120px; margin: 0 auto; position: relative; text-align: center; }
        .gauge { width: 120px; height: 60px; background: #eee; border-top-left-radius: 120px; border-top-right-radius: 120px; overflow: hidden; position: relative; }
        .gauge-fill { width: 100%; height: 100%; background: var(--success); transform-origin: bottom center; transform: rotate(0deg); transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .gauge-value { font-size: 28px; font-weight: bold; margin-top: 10px; color: var(--text-main); }
        
        /* Sandbox Styles */
        .sandbox-container { display: flex; height: 500px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .sb-chat { flex: 1; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-body); }
        .sb-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .sb-msg { padding: 10px 15px; border-radius: 8px; max-width: 80%; font-size: 14px; line-height: 1.5; }
        .sb-msg.user { background: var(--sb-user-bg); color: var(--primary); align-self: flex-end; border-bottom-right-radius: 2px; }
        .sb-msg.bot { background: var(--sb-bot-bg); border: 1px solid var(--border); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .sb-input-area { padding: 15px; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .sb-input { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 4px; outline: none; background: var(--bg-body); color: var(--text-main); }
        
        .sb-debug { width: 300px; padding: 15px; background: var(--bg-card); font-size: 13px; overflow-y: auto; }
        .debug-header { font-weight: 700; color: var(--text-sub); margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; text-transform: uppercase; font-size: 11px; }
        .debug-item { margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 4px; border: 1px solid var(--border); animation: flash 0.5s; }
        .debug-key { font-weight: 600; color: var(--text-sub); margin-bottom: 4px; font-size: 11px; }
        
        .score-high { color: var(--success); font-weight: bold; }
        .score-med { color: var(--warning); font-weight: bold; }
        .score-low { color: var(--danger); font-weight: bold; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flash { 0% { background-color: rgba(0, 101, 255, 0.1); } 100% { background-color: transparent; } }
    </style>
</head>
<body>

    <div id="toast" class="toast">
        <i class="fa-solid fa-circle-check"></i>
        <span id="toastMsg">Action successful</span>
    </div>
    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(this)">

    <div class="top-nav">
        <div style="font-weight: bold; display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-shield-halved"></i> Admin Master Console
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn" onclick="toggleDarkMode()" style="background:rgba(255,255,255,0.2); color:white; border:none;">
                <i class="fa-solid fa-moon"></i> Dark Mode
            </button>
            <div style="font-size: 13px; opacity: 0.8;">Admin: Tran Hoang</div>
        </div>
    </div>

    <div class="main-container">
        <div class="admin-sidebar">
            <div class="menu-item active" onclick="switchTab('dashboard', this)">
                <i class="fa-solid fa-chart-line" style="width:20px"></i> Quan trắc KPI
            </div>
            <div class="menu-item" onclick="switchTab('security', this)">
                <i class="fa-solid fa-lock" style="width:20px"></i> Bảo mật & Audit
            </div>
            <div class="menu-item" onclick="switchTab('rag', this)">
                <i class="fa-solid fa-database" style="width:20px"></i> Quản lý KB & RAG
            </div>
            <div style="margin-top:auto; padding: 20px;">
                <div style="font-size:11px; color:var(--text-sub);">System Status: <span style="color:var(--success)">● Stable</span></div>
            </div>
        </div>

        <div class="admin-content">

            <div id="dashboard" class="section-view active">
                <h2 style="margin-bottom:20px;">Insight Dashboard & Alerting</h2>
                
                <div class="row">
                    <div class="col-8">
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                                <h4 style="color:var(--text-main)">Real-time Traffic & Doanh thu</h4>
                                <select class="filter-input"><option>1 giờ qua</option><option>24 giờ qua</option></select>
                            </div>
                            <div class="chart-container" id="revenueChart"></div>
                        </div>

                        <div class="row">
                            <div class="card" style="flex:1">
                                <h4>CSAT (Real-time)</h4>
                                <div style="font-size:32px; font-weight:bold; color:var(--success); margin:10px 0;">4.8/5.0</div>
                                <div style="font-size:12px; color:var(--text-sub);">Dựa trên 150 đánh giá vừa xong</div>
                            </div>
                            <div class="card" style="flex:1">
                                <h4>Tỷ lệ giải quyết (FCR)</h4>
                                <div style="font-size:32px; font-weight:bold; color:var(--primary); margin:10px 0;">78%</div>
                                <div style="font-size:12px; color:var(--text-sub);">Tăng 2% so với hôm qua</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-4">
                        <div class="card">
                            <h4 style="margin-bottom:15px;">Alert Feed <span style="background:red; color:white; padding:1px 6px; border-radius:10px; font-size:11px;">2</span></h4>
                            <div class="alert-feed">
                                <div class="alert-item critical">
                                    <div class="alert-header">
                                        <span style="color:var(--danger)"><i class="fa-solid fa-circle-exclamation"></i> Khiếu nại tăng</span>
                                        <span style="font-size:10px;">vừa xong</span>
                                    </div>
                                    <div class="alert-desc">Tỷ lệ khiếu nại từ kho Hà Nội tăng đột biến 20% trong 30p qua.</div>
                                    <button class="btn" style="margin-top:5px; width:100%; font-size:11px;">Xem chi tiết</button>
                                </div>
                                <div class="alert-item warning">
                                    <div class="alert-header">
                                        <span style="color:var(--warning)"><i class="fa-solid fa-triangle-exclamation"></i> Phản hồi chậm</span>
                                        <span style="font-size:10px;">10p trước</span>
                                    </div>
                                    <div class="alert-desc">Thời gian chờ trung bình vượt ngưỡng 5 phút (Kênh Zalo).</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h4 style="margin-bottom:15px;">Cấu hình ngưỡng cảnh báo</h4>
                            <div class="threshold-config">
                                <div class="slider-group">
                                    <div class="slider-label"><span>Max Response Time</span> <span style="color:var(--primary)">5 min</span></div>
                                    <input type="range" min="1" max="15" value="5">
                                </div>
                                <button class="btn btn-primary" style="width:100%">Lưu cấu hình</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="security" class="section-view">
                <h2 style="margin-bottom:20px;">Security Center & Audit Logs</h2>

                <div class="card">
                    <h4 style="margin-bottom:15px;">Bảng phân quyền (RBAC Matrix)</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Quyền hạn</th>
                                <th style="text-align:center">Admin</th>
                                <th style="text-align:center">Manager</th>
                                <th style="text-align:center">Staff</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Truy cập Customer 360 (PII Full)</td>
                                <td style="text-align:center"><label class="toggle-switch"><input type="checkbox" checked disabled><span class="slider"></span></label></td>
                                <td style="text-align:center"><label class="toggle-switch"><input type="checkbox" checked><span class="slider"></span></label></td>
                                <td style="text-align:center"><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></td>
                            </tr>
                            <tr>
                                <td>Xóa/Hủy Đơn hàng</td>
                                <td style="text-align:center"><label class="toggle-switch"><input type="checkbox" checked disabled><span class="slider"></span></label></td>
                                <td style="text-align:center"><label class="toggle-switch"><input type="checkbox" checked><span class="slider"></span></label></td>
                                <td style="text-align:center"><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h4 style="margin-bottom:15px;">Nhật ký hệ thống (Audit Trail)</h4>
                    <div class="filter-bar">
                        <select class="filter-input"><option>Tất cả hành động</option><option>Login</option><option>Export</option></select>
                        <input type="text" class="filter-input" placeholder="User hoặc IP..." style="flex:1">
                        <button class="btn btn-primary">Lọc</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr><th>Thời gian</th><th>User</th><th>Hành động</th><th>Đối tượng</th><th>Rủi ro PII</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>10:45:12 - Hôm nay</td>
                                <td><b>hoang.tran</b></td>
                                <td style="color:var(--primary)">Export Data</td>
                                <td>Customer_List_Q3.xlsx</td>
                                <td><span class="pii-badge">PII DETECTED</span></td>
                            </tr>
                            <tr>
                                <td>10:42:00 - Hôm nay</td>
                                <td>my.nguyen</td>
                                <td>View Profile</td>
                                <td>Customer #9988</td>
                                <td><span style="color:green; font-size:10px;">Clean</span></td>
                            </tr>
                             <tr>
                                <td>22:00:00 - Hôm qua</td>
                                <td><b>unknown</b></td>
                                <td style="color:var(--danger)">Failed Login</td>
                                <td>Admin Portal</td>
                                <td><span style="color:gray; font-size:10px;">N/A</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="rag" class="section-view">
                <h2 style="margin-bottom:20px;">Quản lý Tri thức & Sức khỏe RAG</h2>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <input type="text" id="kbSearch" placeholder="Tìm kiếm bài viết..." class="filter-input" style="width:300px;" onkeyup="filterTable()">
                        <div>
                            <button class="btn btn-outline" onclick="triggerExport()"><i class="fa-solid fa-file-export"></i> Export</button>
                            <button class="btn btn-primary" onclick="triggerImport()"><i class="fa-solid fa-cloud-arrow-up"></i> Import</button>
                        </div>
                    </div>
                    <table class="data-table" id="kbTable">
                        <thead><tr><th>Tên tài liệu</th><th>Danh mục</th><th>Trạng thái Index</th><th>Thao tác</th></tr></thead>
                        <tbody>
                            <tr>
                                <td><i class="fa-regular fa-file-pdf" style="color:red"></i> Chinh_sach_2024.pdf</td>
                                <td>Chính sách</td>
                                <td><span class="status-badge" style="background:rgba(54, 179, 126, 0.2); color:green">Indexed</span></td>
                                <td><i class="fa-solid fa-pen" style="cursor:pointer"></i></td>
                            </tr>
                            <tr>
                                <td><i class="fa-regular fa-file-code" style="color:orange"></i> Quy_trinh_hoan_tien.md</td>
                                <td>Quy trình</td>
                                <td><span class="status-badge" style="background:rgba(255, 171, 0, 0.2); color:#b38600">Processing...</span></td>
                                <td><i class="fa-solid fa-rotate" style="cursor:pointer"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="row">
                    <div class="col-4">
                        <div class="card" style="height: 100%;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <h4>Sức khỏe RAG</h4>
                                <button class="btn btn-outline" style="font-size:11px;" onclick="refreshHealthData()"><i class="fa-solid fa-arrows-rotate"></i></button>
                            </div>
                            
                            <div style="text-align:center; margin-bottom:20px;">
                                <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">COVERAGE</div>
                                <div class="gauge-wrapper">
                                    <div class="gauge"><div id="gaugeFill" class="gauge-fill" style="transform: rotate(145deg);"></div></div>
                                </div>
                                <div id="gaugeText" class="gauge-value">82%</div>
                            </div>
                            
                            <div style="text-align:center; margin-bottom:20px;">
                                <div style="font-size:11px; color:var(--text-sub);">PRECISION</div>
                                <div style="font-size:24px; font-weight:bold; color:var(--primary);" id="precisionText">94.5%</div>
                            </div>

                            <div style="text-align:center;">
                                <div style="font-size:11px; color:var(--text-sub);">HALLUCINATION RATE</div>
                                <div style="height:6px; background:#eee; border-radius:3px; margin:5px 0; overflow:hidden;">
                                    <div id="hallucinationBar" style="width:3.2%; height:100%; background:green; transition: width 0.5s;"></div>
                                </div>
                                <div id="hallucinationText" style="font-size:18px; font-weight:bold;">3.2%</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-8">
                        <div class="card">
                            <h4 style="margin-bottom:15px;">Testing Sandbox (AI Debugging)</h4>
                            <div class="sandbox-container">
                                <div class="sb-chat">
                                    <div class="sb-messages" id="sbMessages">
                                        <div class="sb-msg bot">Hệ thống RAG sẵn sàng. Nhập câu hỏi để kiểm tra trích xuất nguồn.</div>
                                    </div>
                                    <div class="sb-input-area">
                                        <input type="text" id="sbInput" class="sb-input" placeholder="Ví dụ: 'Chính sách đổi trả', 'Giá sản phẩm'..." onkeypress="handleEnter(event)">
                                        <button class="btn btn-primary" onclick="sendSandbox()"><i class="fa-solid fa-paper-plane"></i></button>
                                    </div>
                                </div>
                                <div class="sb-debug" id="sbDebug">
                                    <div class="debug-header">System Logs</div>
                                    <div style="color:var(--text-sub); font-style:italic; text-align:center; margin-top:50px;">Chờ truy vấn...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- COMMON UTILS ---
        function switchTab(tabId, btn) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMsg');
            toast.className = `toast ${type}`;
            msg.innerText = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // --- DASHBOARD CHARTS ---
        function renderChart() {
            const container = document.getElementById('revenueChart');
            container.innerHTML = '';
            for(let i=0; i<30; i++) {
                const height = Math.floor(Math.random() * 80) + 10;
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = height + '%';
                bar.style.width = '3%';
                bar.innerHTML = `<div class="bar-tooltip">${height} Tickets</div>`;
                container.appendChild(bar);
            }
        }
        renderChart();
        setInterval(renderChart, 5000);

        // --- RAG FUNCTIONS ---
        function filterTable() {
            const input = document.getElementById('kbSearch');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('kbTable');
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                }       
            }
        }

        function triggerImport() { document.getElementById('fileInput').click(); }
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                showToast(`Đang index: ${input.files[0].name}...`, 'info');
                setTimeout(() => { showToast('Import thành công!', 'success'); }, 1500);
            }
        }
        function triggerExport() { showToast('Đang xuất dữ liệu...', 'info'); setTimeout(() => { showToast('Export hoàn tất', 'success'); }, 1000); }

        function refreshHealthData() {
            const btn = event.currentTarget.querySelector('i');
            btn.classList.add('fa-spin');
            setTimeout(() => {
                const newCoverage = Math.floor(Math.random() * (95 - 70) + 70);
                const newHallucination = (Math.random() * (6 - 1) + 1).toFixed(1);
                
                document.getElementById('gaugeFill').style.transform = `rotate(${(newCoverage / 100) * 180}deg)`;
                document.getElementById('gaugeText').innerText = newCoverage + "%";
                document.getElementById('hallucinationText').innerText = newHallucination + "%";
                document.getElementById('hallucinationBar').style.width = newHallucination + "%";
                document.getElementById('hallucinationBar').style.background = newHallucination > 5 ? "red" : "green";
                
                btn.classList.remove('fa-spin');
                showToast('Dữ liệu Health đã cập nhật', 'success');
            }, 800);
        }

        // --- SANDBOX LOGIC ---
        function handleEnter(e) { if (e.key === 'Enter') sendSandbox(); }

        function sendSandbox() {
            const input = document.getElementById('sbInput');
            const msgs = document.getElementById('sbMessages');
            const debugPanel = document.getElementById('sbDebug');
            const text = input.value.trim();
            if (!text) return;

            msgs.innerHTML += `<div class="sb-msg user">${text}</div>`;
            input.value = '';
            msgs.scrollTop = msgs.scrollHeight;

            const typingId = 'typing-' + Date.now();
            msgs.innerHTML += `<div id="${typingId}" class="sb-msg bot" style="color:gray; font-style:italic;">AI đang suy luận...</div>`;
            msgs.scrollTop = msgs.scrollHeight;

            setTimeout(() => {
                document.getElementById(typingId).remove();
                
                let botResponse = "";
                let debugData = {};
                const lowerText = text.toLowerCase();

                if (lowerText.includes("chính sách") || lowerText.includes("đổi trả")) {
                    botResponse = "Theo <b>Chinh_sach_2024.pdf</b>, bạn được đổi trả trong 30 ngày nếu lỗi NSX.";
                    debugData = { source: "Chinh_sach_2024.pdf", confidence: "High", hallucination: "Low" };
                } else if (lowerText.includes("giá")) {
                    botResponse = "Không tìm thấy bảng giá trong KB. Vui lòng kiểm tra file excel.";
                    debugData = { source: "N/A", confidence: "Low", hallucination: "Risk" };
                } else {
                    botResponse = "Quy trình nội bộ yêu cầu phản hồi khách hàng trong 24h (Mã: KN-001).";
                    debugData = { source: "Quy_trinh.md", confidence: "Medium", hallucination: "Low" };
                }

                msgs.innerHTML += `<div class="sb-msg bot">${botResponse}</div>`;
                msgs.scrollTop = msgs.scrollHeight;

                let confClass = debugData.confidence === 'High' ? 'score-high' : (debugData.confidence === 'Low' ? 'score-low' : 'score-med');
                debugPanel.innerHTML = `
                    <div class="debug-header">Analysis Result</div>
                    <div class="debug-item"><div class="debug-key">Query:</div>"${text}"</div>
                    <div class="debug-item"><div class="debug-key">Source:</div>${debugData.source}</div>
                    <div class="debug-item"><div class="debug-key">Confidence:</div><span class="${confClass}">${debugData.confidence}</span></div>
                `;
            }, 1000);
        }
    </script>
</body>
</html>