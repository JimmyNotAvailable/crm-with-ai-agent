# =============================================================================
# CRM-AI-Agent Database Dockerfile
# Custom MySQL image with initialization scripts and UTF-8 configuration
# =============================================================================
# NOTE: This Dockerfile is for SINGLE DATABASE MODE only (port 3307)
#       For MICROSERVICES mode (ports 3310-3316), use docker-compose directly
#       with the mysql:8.0 image and volume mounts to scripts/sql/*.sql
#
# BUILD:
#   docker build -f docker/Dockerfile.database -t crm-mysql .
#
# RUN (Single DB Mode):
#   docker run -d -p 3307:3306 --name crm-mysql \
#     -e MYSQL_ROOT_PASSWORD=root123 \
#     -e MYSQL_DATABASE=crm_ai_db \
#     -e MYSQL_USER=crm_user \
#     -e MYSQL_PASSWORD=crm_admin_pass \
#     crm-mysql
#
# DataGrip Connection (Single Mode):
#   Host: localhost | Port: 3307 | Database: crm_ai_db
#   User: crm_user  | Password: crm_admin_pass
#
# For Microservices connections, see: scripts/datagrip_connections.md
# =============================================================================

FROM mysql:8.0

# Labels
LABEL maintainer="CRM-AI-Agent Team"
LABEL description="MySQL 8.0 with UTF-8 support and CRM schema (Single DB Mode)"

# Set environment variables for UTF-8
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Copy custom MySQL configuration for UTF-8 (same as microservices)
COPY docker/mysql/utf8.cnf /etc/mysql/conf.d/utf8.cnf

# Copy initialization scripts (executed in alphabetical order)
# full_schema.sql contains the complete unified schema for single DB mode
COPY backend/database/full_schema.sql /docker-entrypoint-initdb.d/01_schema.sql

# Optional: Copy seed data if exists
# COPY scripts/init_crm_database.sql /docker-entrypoint-initdb.d/02_seed_data.sql

# Set proper permissions
RUN chmod 644 /etc/mysql/conf.d/utf8.cnf && \
    chmod 644 /docker-entrypoint-initdb.d/*.sql 2>/dev/null || true

# Health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=5 \
    CMD mysqladmin ping -h localhost -u root -p${MYSQL_ROOT_PASSWORD} || exit 1

# Expose MySQL port
EXPOSE 3306

# Default command with UTF-8 settings
CMD ["mysqld", \
     "--character-set-server=utf8mb4", \
     "--collation-server=utf8mb4_unicode_ci", \
     "--default-authentication-plugin=mysql_native_password"]
