# =============================================================================
# CRM-AI-Agent: Unified Docker Compose Configuration
# Gộp tất cả các services: Full-stack, Database Dev, Microservices
# =============================================================================
# USAGE:
#   Chạy Full-stack (Backend + Frontend + MySQL):
#     docker-compose -f docker/docker-compose.yml up -d
#
#   Chạy chỉ Database (Development):
#     docker-compose -f docker/docker-compose.yml --profile database up -d
#
#   Chạy Microservices Database (7 MySQL instances):
#     docker-compose -f docker/docker-compose.yml --profile microservices up -d
#
#   Chạy tất cả:
#     docker-compose -f docker/docker-compose.yml --profile all up -d
# =============================================================================

services:
  # ===========================================================================
  # CORE SERVICES (Default profile - Full-stack deployment)
  # ===========================================================================

  # MySQL Database - Single instance for monolithic mode
  # DataGrip connection: localhost:3307, user: crm_user, pass: crm_admin_pass
  mysql:
    build:
      context: ..
      dockerfile: docker/Dockerfile.database
    image: crm-mysql:latest
    container_name: crm-mysql
    restart: always
    profiles: ["default", "database", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: crm_ai_db
      MYSQL_USER: crm_user
      MYSQL_PASSWORD: crm_admin_pass
    ports:
      - "3307:3306"  # DataGrip: localhost:3307
    volumes:
      - mysql_data:/var/lib/mysql
      # Mount for hot-reload SQL scripts (optional, remove in production)
      # - ../backend/database:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot123"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-network

  # Backend API (FastAPI)
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      args:
        BUILD_MODE: prod
    container_name: crm-backend
    restart: always
    profiles: ["default", "all"]
    environment:
      # Database - match with mysql service
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: crm_user
      MYSQL_PASSWORD: crm_admin_pass
      MYSQL_DATABASE: crm_ai_db
      
      # Demo Mode
      DEMO_MODE: "True"
      
      # Vector Database
      CHROMA_PERSIST_DIRECTORY: /app/vector_store
      CHROMA_COLLECTION_NAME: kb_articles
      
      # OpenAI (Optional)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      
      # Authentication
      SECRET_KEY: demo-secret-jwt-key-change-in-production
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 60
      
      # Logging
      LOG_LEVEL: INFO
      LOG_FILE: /app/logs/app.log
    ports:
      - "8000:8000"
    volumes:
      - ../uploads:/app/uploads
      - ../logs:/app/logs
      - ../vector_store:/app/vector_store
      - ../chroma_db:/app/chroma_db
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - crm-network

  # Frontend (React + Nginx)
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: crm-frontend
    restart: always
    profiles: ["default", "all"]
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - crm-network

  # Adminer (Database Admin UI)
  adminer:
    image: adminer:latest
    container_name: crm-adminer
    restart: unless-stopped
    profiles: ["default", "database", "all"]
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: mysql
    depends_on:
      - mysql
    networks:
      - crm-network

  # ===========================================================================
  # MICROSERVICES DATABASE (Profile: microservices)
  # 7 separate MySQL instances for microservices architecture
  # ===========================================================================

  # 1. Identity Database (Port 3310)
  mysql-identity:
    image: mysql:8.0
    container_name: crm-mysql-identity
    restart: unless-stopped
    profiles: ["microservices", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root_identity_pass
      MYSQL_DATABASE: crm_identity_db
      MYSQL_USER: identity_user
      MYSQL_PASSWORD: identity_pass
      LANG: C.UTF-8
    ports:
      - "3310:3306"
    volumes:
      - identity_data:/var/lib/mysql
      - ./mysql/utf8.cnf:/etc/mysql/conf.d/utf8.cnf:ro
      - ../scripts/sql/01_identity_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --character-set-client-handshake=FALSE
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_identity_pass"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-microservices-network

  # 2. Product Database (Port 3311)
  mysql-product:
    image: mysql:8.0
    container_name: crm-mysql-product
    restart: unless-stopped
    profiles: ["microservices", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root_product_pass
      MYSQL_DATABASE: crm_product_db
      MYSQL_USER: product_user
      MYSQL_PASSWORD: product_pass
      LANG: C.UTF-8
    ports:
      - "3311:3306"
    volumes:
      - product_data:/var/lib/mysql
      - ./mysql/utf8.cnf:/etc/mysql/conf.d/utf8.cnf:ro
      - ../scripts/sql/02_product_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --character-set-client-handshake=FALSE
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_product_pass"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-microservices-network

  # 3. Order Database (Port 3312)
  mysql-order:
    image: mysql:8.0
    container_name: crm-mysql-order
    restart: unless-stopped
    profiles: ["microservices", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root_order_pass
      MYSQL_DATABASE: crm_order_db
      MYSQL_USER: order_user
      MYSQL_PASSWORD: order_pass
      LANG: C.UTF-8
    ports:
      - "3312:3306"
    volumes:
      - order_data:/var/lib/mysql
      - ./mysql/utf8.cnf:/etc/mysql/conf.d/utf8.cnf:ro
      - ../scripts/sql/03_order_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --character-set-client-handshake=FALSE
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_order_pass"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-microservices-network

  # 4. Support Database (Port 3313)
  mysql-support:
    image: mysql:8.0
    container_name: crm-mysql-support
    restart: unless-stopped
    profiles: ["microservices", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root_support_pass
      MYSQL_DATABASE: crm_support_db
      MYSQL_USER: support_user
      MYSQL_PASSWORD: support_pass
      LANG: C.UTF-8
    ports:
      - "3313:3306"
    volumes:
      - support_data:/var/lib/mysql
      - ./mysql/utf8.cnf:/etc/mysql/conf.d/utf8.cnf:ro
      - ../scripts/sql/04_support_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --character-set-client-handshake=FALSE
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_support_pass"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-microservices-network

  # 5. Knowledge Database (Port 3314)
  mysql-knowledge:
    image: mysql:8.0
    container_name: crm-mysql-knowledge
    restart: unless-stopped
    profiles: ["microservices", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root_knowledge_pass
      MYSQL_DATABASE: crm_knowledge_db
      MYSQL_USER: knowledge_user
      MYSQL_PASSWORD: knowledge_pass
      LANG: C.UTF-8
    ports:
      - "3314:3306"
    volumes:
      - knowledge_data:/var/lib/mysql
      - ./mysql/utf8.cnf:/etc/mysql/conf.d/utf8.cnf:ro
      - ../scripts/sql/05_knowledge_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --character-set-client-handshake=FALSE
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_knowledge_pass"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-microservices-network

  # 6. Analytics Database (Port 3315)
  mysql-analytics:
    image: mysql:8.0
    container_name: crm-mysql-analytics
    restart: unless-stopped
    profiles: ["microservices", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root_analytics_pass
      MYSQL_DATABASE: crm_analytics_db
      MYSQL_USER: analytics_user
      MYSQL_PASSWORD: analytics_pass
      LANG: C.UTF-8
    ports:
      - "3315:3306"
    volumes:
      - analytics_data:/var/lib/mysql
      - ./mysql/utf8.cnf:/etc/mysql/conf.d/utf8.cnf:ro
      - ../scripts/sql/06_analytics_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --character-set-client-handshake=FALSE
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_analytics_pass"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-microservices-network

  # 7. Marketing Database (Port 3316)
  mysql-marketing:
    image: mysql:8.0
    container_name: crm-mysql-marketing
    restart: unless-stopped
    profiles: ["microservices", "all"]
    environment:
      MYSQL_ROOT_PASSWORD: root_marketing_pass
      MYSQL_DATABASE: crm_marketing_db
      MYSQL_USER: marketing_user
      MYSQL_PASSWORD: marketing_pass
      LANG: C.UTF-8
    ports:
      - "3316:3306"
    volumes:
      - marketing_data:/var/lib/mysql
      - ./mysql/utf8.cnf:/etc/mysql/conf.d/utf8.cnf:ro
      - ../scripts/sql/07_marketing_db.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --character-set-client-handshake=FALSE
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_marketing_pass"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-microservices-network

  # Adminer for Microservices
  adminer-microservices:
    image: adminer:latest
    container_name: crm-adminer-microservices
    restart: unless-stopped
    profiles: ["microservices", "all"]
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: mysql-identity
    depends_on:
      - mysql-identity
      - mysql-product
      - mysql-order
      - mysql-support
      - mysql-knowledge
      - mysql-analytics
      - mysql-marketing
    networks:
      - crm-microservices-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # Single database mode
  mysql_data:
    driver: local
  
  # Microservices mode
  identity_data:
    name: crm_identity_data
  product_data:
    name: crm_product_data
  order_data:
    name: crm_order_data
  support_data:
    name: crm_support_data
  knowledge_data:
    name: crm_knowledge_data
  analytics_data:
    name: crm_analytics_data
  marketing_data:
    name: crm_marketing_data

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  crm-network:
    driver: bridge
  crm-microservices-network:
    name: crm-microservices-network
    driver: bridge
